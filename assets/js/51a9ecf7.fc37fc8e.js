(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[6755],{5318:function(e){e.exports=function(e){return e&&e.__esModule?e:{default:e}},e.exports.__esModule=!0,e.exports.default=e.exports},3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),m=i,h=p["".concat(l,".").concat(m)]||p[m]||d[m]||o;return n?a.createElement(h,r(r({ref:t},u),{},{components:n})):a.createElement(h,r({ref:t},u))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var c=2;c<o;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},8698:function(e,t,n){"use strict";var a=n(5318);t.Z=void 0;var i=a(n(4938)),o=n(5893),r=(0,i.default)((0,o.jsx)("path",{d:"M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3 1 9l11 6 9-4.91V17h2V9L12 3z"}),"School");t.Z=r},4938:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return a.createSvgIcon}});var a=n(8435)},8435:function(e,t,n){"use strict";n.r(t),n.d(t,{capitalize:function(){return i.Z},createChainedFunction:function(){return o},createSvgIcon:function(){return r.Z},debounce:function(){return s},deprecatedPropType:function(){return l},isMuiElement:function(){return c.Z},ownerDocument:function(){return d},ownerWindow:function(){return p},requirePropFactory:function(){return m},setRef:function(){return h},unstable_ClassNameGenerator:function(){return N},unstable_useEnhancedEffect:function(){return g.Z},unstable_useId:function(){return f.Z},unsupportedProp:function(){return y},useControlled:function(){return v.Z},useEventCallback:function(){return k.Z},useForkRef:function(){return b.Z},useIsFocusVisible:function(){return w.Z}});var a=n(8076),i=n(8216);var o=function(...e){return e.reduce(((e,t)=>null==t?e:function(...n){e.apply(this,n),t.apply(this,n)}),(()=>{}))},r=n(8169);var s=function(e,t=166){let n;function a(...a){clearTimeout(n),n=setTimeout((()=>{e.apply(this,a)}),t)}return a.clear=()=>{clearTimeout(n)},a};var l=function(e,t){return()=>null},c=n(1579),u=n(7094),d=u.Z;var p=function(e){return(0,u.Z)(e).defaultView||window};n(7462);var m=function(e,t){return()=>null},h=n(7960).Z,g=n(8974),f=n(8785);var y=function(e,t,n,a,i){return null},v=n(2627),k=n(9327),b=n(1705),w=n(8791);const N={configure:e=>{console.warn(["MUI: `ClassNameGenerator` import from `@mui/material/utils` is outdated and might cause unexpected issues.","","You should use `import { unstable_ClassNameGenerator } from '@mui/material/className'` instead","","The detail of the issue: https://github.com/mui/material-ui/issues/30011#issuecomment-1024993401","","The updated documentation: https://mui.com/guides/classname-generator/"].join("\n")),a.Z.configure(e)}}},1579:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var a=n(7294);var i=function(e,t){return a.isValidElement(e)&&-1!==t.indexOf(e.type.muiName)}},8974:function(e,t,n){"use strict";var a=n(6600);t.Z=a.Z},3123:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var a=n(7294),i=n(6010),o={note:a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},a.createElement("path",{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})),tip:a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},a.createElement("path",{fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"})),danger:a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},a.createElement("path",{fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"})),info:a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},a.createElement("path",{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})),caution:a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},a.createElement("path",{fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))},r={note:"secondary",tip:"success",danger:"danger",info:"info",caution:"warning"};function s(e){var t=e.children,n=e.type,s=e.title,l=void 0===s?n:s,c=e.icon,u=void 0===c?o[n]:c;return a.createElement("div",{className:(0,i.Z)("admonition","admonition-"+n,"alert","alert--"+r[n])},a.createElement("div",{className:"admonition-heading"},a.createElement("h5",null,a.createElement("span",{className:"admonition-icon"},u),l)),a.createElement("div",{className:"admonition-content"},t))}},2798:function(e){e.exports={siteHome:"https://moodle.academy/",courses:{setup:{id:29,name:"Set up your Moodle Development Environment",summary:"Learn about the Moodle developer community and setting up a development environment",description:"This course is designed for PHP developers who want to start developing Moodle plugins. You will learn about the Moodle developer community and set up a Moodle development environment. This is the first course in the Developer Pathway. Subsequent courses in the the Developer Pathway will build on the knowledge gained in this course.",tags:["development","basics","setup"],archived:!1,series:[]},securityEssentials:{id:53,name:"Moodle Access and Security Essentials",summary:"A short course looking at access control and security aspects of plugins.",description:"In this course we look at access control and security aspects of a plugin. Through a set of tutorials, you will learn how to control access to your plugin using Moodle's Access API. You will learn how to define capabilities in your plugin and how to determine if the user has the permission to access a page. This course also covers common security threats that developers need to be aware of.\n\nThis is the fourth course in the Moodle Developer Basics program.",tags:["development","basic","essentials","security","api"],archived:!1,series:["basics"]},outputEssentials:{id:49,name:"Web Output Essentials",summary:"Learn how to use Moodle's Page and Output APIs to display content in a local plugin.",description:"This course builds on the knowledge gained in the Moodle development environment course. In this course, we learn how to use Moodle's Page and Output APIs to display content in a local plugin. An introduction to localisation using language strings is also covered in this course. This is the second course in the Moodle developer pathway.",tags:["development","basics","essentials","output","api"],archived:!1,series:["basics"]},architecture:{id:51,name:"Moodle's Modular Architecture and APIs",summary:"Take a deeper look at Moodle's architecture, exploring common APIs including Navigations, Forms, Database, Upgrade, Strings, and Output.",description:"In this course we take a deeper look at Moodle's modular architecture and explore the use of common Moodle APIs. Some of the APIs covered in this course include: Navigation, Forms, Database access, Upgrade, Strings and Output APIs. Learners get hands-on practise on using these APIs in the form of developing a local plugin.\n\nThis is the third course in the Moodle Developer Basics program.",tags:["development","api","architecture"],archived:!1,series:["basics"]},pluginBasics:{id:10,name:"Moodle Plugin Development Basics",summary:"Learn about the essential concepts in Moodle's moduel architecture.",description:"This course teaches you essential concepts related to Moodle's modular architecture, enabling you to develop a simple demo plugin.\n\nPlease note, this course is being migrated to form a new program of short courses on Moodle Academy (called 'Moodle Developer Basics'), which will all be available at the end of April 2022. For now you may still complete the course on Learn Moodle, or you might like to start the Moodle Academy developer short courses that are being released over the coming weeks and will form this new beginner level program.",tags:["development","basics","essentials","api","plugins","architecture"],archived:!1,series:["basics"]}}}},6134:function(e,t,n){"use strict";n.d(t,{Z:function(){return u}});var a=n(7294),i=n(3123),o=n(9960),r=n(8698),s=n(2798),l=n.n(s),c=n(684);function u(e){var t=e.courseName;if(!l().courses[t])throw Error("Unknown course "+t);var n=l().courses[t];return a.createElement(i.Z,{type:"info",icon:a.createElement(r.Z,{fontSize:"inherit"}),title:"Learn more on Moodle Academy"},"You can learn more about"," ",a.createElement("strong",null,e.subject)," ","from the"," ",a.createElement(c.Z,{title:n.summary},a.createElement(o.Z,{to:l().siteHome+"course/view.php?id="+n.id},n.name))," ","on Moodle Academy.")}},6330:function(e,t,n){"use strict";n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return c},default:function(){return h},frontMatter:function(){return l},metadata:function(){return u},toc:function(){return p}});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),r=n(6134),s=["components"],l={title:"Access API",tags:["Access"]},c=void 0,u={unversionedId:"apis/subsystems/access",id:"apis/subsystems/access",title:"Access API",description:"The Access API gives you functions so you can determine what the current user is allowed to do. It also allows plugins to extend Moodle with new capabilities.",source:"@site/docs/apis/subsystems/access.md",sourceDirName:"apis/subsystems",slug:"/apis/subsystems/access",permalink:"/devdocs/docs/apis/subsystems/access",editUrl:"https://github.com/moodle/devdocs/edit/main/docs/apis/subsystems/access.md",tags:[{label:"Access",permalink:"/devdocs/docs/tags/access"}],version:"current",lastUpdatedBy:"Sara Arjona",lastUpdatedAt:1652339309,formattedLastUpdatedAt:"12/05/2022",frontMatter:{title:"Access API",tags:["Access"]},sidebar:"docs",previous:{title:"Subsystems",permalink:"/devdocs/docs/category/subsystems"},next:{title:"File API",permalink:"/devdocs/docs/apis/subsystems/files/"}},d={},p=[{value:"Overview",id:"overview",level:2},{value:"How to define new capabilities in plugins",id:"how-to-define-new-capabilities-in-plugins",level:2},{value:"Useful functions and classes",id:"useful-functions-and-classes",level:2},{value:"Context fetching",id:"context-fetching",level:3},{value:"Determining that a user has a given capability",id:"determining-that-a-user-has-a-given-capability",level:3},{value:"has_capability()",id:"has_capability",level:4},{value:"require_capability()",id:"require_capability",level:4},{value:"Enrolment functions",id:"enrolment-functions",level:3},{value:"Other related functions",id:"other-related-functions",level:3},{value:"<code>require_login()</code>",id:"require_login",level:4},{value:"<code>require_course_login()</code>",id:"require_course_login",level:4},{value:"<code>isguestuser()</code>, <code>isloggedin()</code> and <code>is_siteadmin()</code>",id:"isguestuser-isloggedin-and-is_siteadmin",level:4},{value:"<code>is_guest()</code>, <code>is_viewing()</code> and <code>is_enrolled()</code>",id:"is_guest-is_viewing-and-is_enrolled",level:4},{value:"<code>get_users_by_capability()</code>",id:"get_users_by_capability",level:4},{value:"See also",id:"see-also",level:2}],m={toc:p};function h(e){var t=e.components,n=(0,i.Z)(e,s);return(0,o.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"The Access API gives you functions so you can determine what the current user is allowed to do. It also allows plugins to extend Moodle with new capabilities."),(0,o.kt)("h2",{id:"overview"},"Overview"),(0,o.kt)("p",null,"Moodle uses a role-based access control model. Entities are represented by contexts which are arranged into a tree-like hierarchy known as the context tree."),(0,o.kt)("p",null,"The following context types are available:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Context name"),(0,o.kt)("th",{parentName:"tr",align:null},"Represents"),(0,o.kt)("th",{parentName:"tr",align:null},"Immediate contents"),(0,o.kt)("th",{parentName:"tr",align:null},"Notes"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"context_system")),(0,o.kt)("td",{parentName:"tr",align:null},"The site as a whole"),(0,o.kt)("td",{parentName:"tr",align:null},"user, course category, module, and block"),(0,o.kt)("td",{parentName:"tr",align:null},"The System context is root context in the tree. There is only one System context")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"context_user")),(0,o.kt)("td",{parentName:"tr",align:null},"An individual user"),(0,o.kt)("td",{parentName:"tr",align:null},"block"),(0,o.kt)("td",{parentName:"tr",align:null},"Each user has their own, unique, context")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"context_coursecat")),(0,o.kt)("td",{parentName:"tr",align:null},"A single course category"),(0,o.kt)("td",{parentName:"tr",align:null},"course category, course, block"),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"context_course")),(0,o.kt)("td",{parentName:"tr",align:null},"A single course"),(0,o.kt)("td",{parentName:"tr",align:null},"module, block"),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"context_module")),(0,o.kt)("td",{parentName:"tr",align:null},"An activity"),(0,o.kt)("td",{parentName:"tr",align:null},"block"),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"context_block")),(0,o.kt)("td",{parentName:"tr",align:null},"A block"),(0,o.kt)("td",{parentName:"tr",align:null},"none"),(0,o.kt)("td",{parentName:"tr",align:null})))),(0,o.kt)("p",null,"A Role is a set of capability definitions, where each capability represents something that the user is able to do. Roles are defined at the top most\ncontext in the context tree, the System context."),(0,o.kt)("p",null,"Roles can be overridden by contexts further down the tree."),(0,o.kt)("p",null,"User access is calculated from the combination of roles which are assigned to each user."),(0,o.kt)("p",null,"All users that did not log-in yet automatically get the default role defined in ",(0,o.kt)("inlineCode",{parentName:"p"},"$CFG->notloggedinroleid"),", it is not possible to assign any other role to this non-existent user id. There is one special guest user account that is used when user logs in using the guest login button or when guest auto-login is enabled. Again you can not assign any roles to the guest account directly, this account gets the ",(0,o.kt)("inlineCode",{parentName:"p"},"$CFG->guestroleid")," automatically. All other authenticated users get the default user role specified in ",(0,o.kt)("inlineCode",{parentName:"p"},"$CFG->defaultuserroleid")," and in the frontpage context the role specified in ",(0,o.kt)("inlineCode",{parentName:"p"},"$CFG->defaultfrontpageroleid"),"."),(0,o.kt)(r.Z,{subject:"Contexts and the Roles API",courseName:"securityEssentials",mdxType:"AcademyLink"}),(0,o.kt)("h2",{id:"how-to-define-new-capabilities-in-plugins"},"How to define new capabilities in plugins"),(0,o.kt)("p",null,"Capabilities are defined by ",(0,o.kt)("inlineCode",{parentName:"p"},"$capabilities")," array defined in ",(0,o.kt)("inlineCode",{parentName:"p"},"db/access.php")," files. The name of the capability consists of ",(0,o.kt)("inlineCode",{parentName:"p"},"plugintype/pluginname:capabilityname"),"."),(0,o.kt)("p",null,"For example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/folder/db/access.php"',title:'"mod/folder/db/access.php"'},"$capabilities = [\n    'mod/folder:managefiles' => [\n        'riskbitmask' => RISK_SPAM,\n        'captype' => 'write',\n        'contextlevel' => CONTEXT_MODULE,\n        'archetypes' => [\n            'editingteacher' => CAP_ALLOW,\n        ],\n    ],\n];\n")),(0,o.kt)("p",null,"Where the meaning of array keys is:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Field"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"riskbitmask")),(0,o.kt)("td",{parentName:"tr",align:null},"associated risks. These are explained on ",(0,o.kt)("a",{parentName:"td",href:"https://docs.moodle.org/dev/Hardening_new_Roles_system"},"Hardening new Roles system"),".")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"captype")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("em",{parentName:"td"},"read")," or ",(0,o.kt)("em",{parentName:"td"},"write")," capability type, for security reasons system prevents all write capabilities for guest account and not-logged-in users")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"contextlevel")),(0,o.kt)("td",{parentName:"tr",align:null},"specified as context level constant. Declares the typical context level where this capability is checked. This capability can be checked with contexts that are at a lower level (e.g. ",(0,o.kt)("inlineCode",{parentName:"td"},"moodle/site:accessallgroups"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"archetypes")),(0,o.kt)("td",{parentName:"tr",align:null},"specifies defaults for roles with standard archetypes, this is used in installs, upgrades and when resetting roles (it is recommended to use only CAP_ALLOW here).  Archetypes are defined in mdl_role table.  See also ",(0,o.kt)("a",{parentName:"td",href:"https://docs.moodle.org/dev/Role_archetypes"},"Role archetypes"),".")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"clonepermissionsfrom")),(0,o.kt)("td",{parentName:"tr",align:null},"when you are adding a new capability, you can tell Moodle to copy the permissions for each role from the current settings for another capability. This may give better defaults than just using archetypes for administrators who have heavily customised their roles configuration. The full syntax is: ",(0,o.kt)("inlineCode",{parentName:"td"},"clonepermissionsfrom")," => ",(0,o.kt)("inlineCode",{parentName:"td"},"moodle/quiz:attempt"))))),(0,o.kt)("p",null,"It is necessary to bump up plugin version number after any change in db/access.php, so that the upgrade scripts can make the necessary changes to the database.  To run the upgrade scripts, log in to Moodle as administrator, navigate to the site home page, and follow the instructions.  (If you need to test the upgrade script without changing the plugin version, it is also possible to set back the version number in the mdl_block or mdl_modules table in the database.)"),(0,o.kt)("p",null,'The capability names are defined in plugin language files, the name of the string consists of "pluginname:capabilityname", in the example above it would be:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="mod/folder/lang/en/folder.php"',title:'"mod/folder/lang/en/folder.php"'},"$string['folder:managefiles'] = 'Manage files in folder module';\n")),(0,o.kt)("h2",{id:"useful-functions-and-classes"},"Useful functions and classes"),(0,o.kt)("h3",{id:"context-fetching"},"Context fetching"),(0,o.kt)("p",null,"In plugins context instances are usually only instantiated because they are instantiated and deleted automatically by the system."),(0,o.kt)("p",null,"Fetching by object id:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"$systemcontext = context_system::instance();\n$usercontext = context_user::instance($user->id);\n$categorycontext = context_coursecat::instance($category->id);\n$coursecontext = context_course::instance($course->id);\n$contextmodule = context_module::instance($cm->id);\n$contextblock = context_block::instance($this->instance->id);\n")),(0,o.kt)("p",null,"Fetching by context id:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"$context = context::instance_by_id($contextid);\n")),(0,o.kt)("p",null,"Notes:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"by default exception is thrown if context can not be created"),(0,o.kt)("li",{parentName:"ul"},"deleted users do not have contexts any more")),(0,o.kt)("h3",{id:"determining-that-a-user-has-a-given-capability"},"Determining that a user has a given capability"),(0,o.kt)("p",null,'When implementing access control always ask "Does the user have capability to do something?". It is incorrect to ask "Does the user have a role somewhere?".'),(0,o.kt)("h4",{id:"has_capability"},"has_capability()"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"has_capability()")," is the most important function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"function has_capability(\n    string $capability,\n    context $context,\n    object $user = null,\n    bool $doanything = true\n): bool;\n")),(0,o.kt)("p",null,"Check whether a user has a particular capability in a given context. For example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"$context = context_module::instance($cm->id);\nif (has_capability('mod/folder:managefiles', $context)) {\n    // Do or display something.\n}\n")),(0,o.kt)("p",null,"By default checks the capabilities of the current user, but you can pass a different user id. By default will return true for admin users, it is not recommended to use false here."),(0,o.kt)("h4",{id:"require_capability"},"require_capability()"),(0,o.kt)("p",null,"Function require_capability() is very similar, it is throwing access control exception if user does not have the capability."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"function require_capability($capability, context $context, $userid = null, $doanything = true, $errormessage = 'nopermissions', $stringfile = _) {\n")),(0,o.kt)("h3",{id:"enrolment-functions"},"Enrolment functions"),(0,o.kt)("p",null,"See ",(0,o.kt)("a",{parentName:"p",href:"https://docs.moodle.org/dev/Enrolment_API"},"Enrolment API"),"."),(0,o.kt)("h3",{id:"other-related-functions"},"Other related functions"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"function require_login($courseorid = null, $autologinguest = true, $cm = null, $setwantsurltome = true, $preventredirect = false)\nfunction require_course_login($courseorid, $autologinguest = true, $cm = null, $setwantsurltome = true, $preventredirect = false)\nfunction get_users_by_capability(context $context, $capability, $fields = _, $sort = _, $limitfrom = _, $limitnum = _,\n                                $groups = _, $exceptions = _, $doanything_ignored = null, $view_ignored = null, $useviewallgroups = false)\nfunction isguestuser($user = null)\nfunction isloggedin()\nfunction is_siteadmin($user_or_id = null)\nfunction is_guest(context $context, $user = null)\nfunction is_viewing(context $context, $user = null, $withcapability = _)\n")),(0,o.kt)("h4",{id:"require_login"},(0,o.kt)("inlineCode",{parentName:"h4"},"require_login()")),(0,o.kt)("p",null,"Each plugin script should include require_login() or require_course_login() after setting up PAGE->url."),(0,o.kt)("p",null,"This function does following:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"it verifies that user is logged in before accessing any course or activities (not-logged-in users can not enter any courses)."),(0,o.kt)("li",{parentName:"ul"},"user is logged in as gu"),(0,o.kt)("li",{parentName:"ul"},"verify access to hidden courses and activities"),(0,o.kt)("li",{parentName:"ul"},"if an activity is specified, verify any ",(0,o.kt)("a",{parentName:"li",href:"https://docs.moodle.org/dev/Availability_API"},"availability restrictions")," for the activity"),(0,o.kt)("li",{parentName:"ul"},"verify that user is either enrolled or has capability 'moodle/course:view' or some enrol plugin gives them temporary guest access"),(0,o.kt)("li",{parentName:"ul"},"logs access to courses")),(0,o.kt)("h4",{id:"require_course_login"},(0,o.kt)("inlineCode",{parentName:"h4"},"require_course_login()")),(0,o.kt)("p",null,"This function is supposed to be used only in activities that want to allow read access to content on the frontpage without logging-in. For example view resource files, reading of glossary  entries, etc."),(0,o.kt)("h4",{id:"isguestuser-isloggedin-and-is_siteadmin"},(0,o.kt)("inlineCode",{parentName:"h4"},"isguestuser()"),", ",(0,o.kt)("inlineCode",{parentName:"h4"},"isloggedin()")," and ",(0,o.kt)("inlineCode",{parentName:"h4"},"is_siteadmin()")),(0,o.kt)("p",null,"These function were previously needed for limiting of access of special accounts. It is usually not necessary any more, because any ",(0,o.kt)("em",{parentName:"p"},"write")," or ",(0,o.kt)("em",{parentName:"p"},"risky")," capabilities are now automatically prevented in has_capability()."),(0,o.kt)("p",null,"It is strongly discouraged to use is_siteadmin() in activity modules, please use standard capabilities and enrolment status instead."),(0,o.kt)("h4",{id:"is_guest-is_viewing-and-is_enrolled"},(0,o.kt)("inlineCode",{parentName:"h4"},"is_guest()"),", ",(0,o.kt)("inlineCode",{parentName:"h4"},"is_viewing()")," and ",(0,o.kt)("inlineCode",{parentName:"h4"},"is_enrolled()")),(0,o.kt)("p",null,"In order to access course data one of these functions must return true for user:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"is_enrolled()")," - user has active record in user_enrolments table"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"is_viewing()")," - user has 'moodle/course:view' capability (may access course, but is not considered to be participant)"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"is_guest()")," - user was given temporary guest access by some enrolment plugin")),(0,o.kt)("h4",{id:"get_users_by_capability"},(0,o.kt)("inlineCode",{parentName:"h4"},"get_users_by_capability()")),(0,o.kt)("p",null,"This method returns list of users with given capability, it ignores enrolment status and should be used only above the course context."),(0,o.kt)("h2",{id:"see-also"},"See also"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/apis"},"API guides")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.moodle.org/dev/Roles"},"Roles")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.moodle.org/dev/Role_archetypes"},"Role archetypes")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.moodle.org/dev/Hardening_new_Roles_system"},"Hardening new Roles system")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.moodle.org/dev/Roles_and_modules"},"Roles and modules")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.moodle.org/dev/NEWMODULE_Adding_capabilities"},"NEWMODULE Adding capabilities")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.moodle.org/dev/New_permissions_evaluation_in_2.0"},"New permissions evaluation in 2.0")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://moodle.org/mod/forum/discuss.php?d=257611"},"(Forums) How to check if current user is student?"))))}h.isMDXComponent=!0}}]);